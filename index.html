<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8b5cf6">
    <meta name="description" content="Flares - Track your mood and connect with your support network">
    <title>Flares - Mood Tracker</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="flares.css">
    <link rel="manifest" href="/manifest.json">

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, getDocs, deleteDoc, where, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBAP0mJC-7jDRZzpv4dWT11A7EhSDFbfSo",
            authDomain: "flare-a0418.firebaseapp.com",
            projectId: "flare-a0418",
            storageBucket: "flare-a0418.firebasestorage.app",
            messagingSenderId: "311211387060",
            appId: "1:311211387060:web:45f0ca4374d5d449054fe1",
            measurementId: "G-K65CLNNFGN"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Initialize FCM (messaging)
        let messaging = null;
        try {
            messaging = getMessaging(app);
        } catch (e) {
            console.warn('FCM not supported in this browser:', e);
        }

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseMessaging = messaging;
        window.firebaseAuthFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile
        };
        window.firebaseDbFunctions = {
            doc,
            setDoc,
            getDoc,
            collection,
            addDoc,
            query,
            orderBy,
            limit,
            getDocs,
            deleteDoc,
            where,
            updateDoc,
            onSnapshot
        };
        window.firebaseMessagingFunctions = {
            getToken,
            onMessage
        };

        // Dispatch event when Firebase is ready
        window.dispatchEvent(new Event('firebaseReady'));
    </script>
</head>
<body>
    <div class="stars"></div>
    <div class="flares-app">
        <!-- Navigation Header -->
        <nav class="flares-nav">
            <div class="nav-container">
                <div class="logo">Flares</div>
                <button class="settings-btn" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </nav>

        <!-- Auth Screen: Login/Signup -->
        <div class="screen active" id="authScreen">
            <div class="screen-content auth-content">
                <div class="auth-logo">
                    <div class="auth-flare"></div>
                    <h1 class="auth-title">Flares</h1>
                    <p class="auth-tagline">Track your mood. Share with your support network.</p>
                </div>

                <!-- Login Form -->
                <div class="auth-form" id="loginForm">
                    <h2>Welcome Back</h2>
                    <div class="auth-fields">
                        <input type="email" id="loginEmail" placeholder="Email" class="input auth-input">
                        <input type="password" id="loginPassword" placeholder="Password" class="input auth-input">
                    </div>
                    <div class="auth-error" id="loginError"></div>
                    <button class="btn btn-primary auth-btn" id="loginBtn">Sign In</button>
                    <p class="auth-switch">
                        Don't have an account?
                        <button class="btn-link-inline" id="showSignup">Sign Up</button>
                    </p>
                </div>

                <!-- Signup Form -->
                <div class="auth-form" id="signupForm" style="display: none;">
                    <h2>Create Account</h2>
                    <div class="auth-fields">
                        <input type="text" id="signupName" placeholder="Display Name" class="input auth-input">
                        <input type="email" id="signupEmail" placeholder="Email" class="input auth-input">
                        <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" class="input auth-input">
                        <input type="password" id="signupConfirm" placeholder="Confirm Password" class="input auth-input">
                    </div>
                    <div class="auth-error" id="signupError"></div>
                    <button class="btn btn-primary auth-btn" id="signupBtn">Create Account</button>
                    <p class="auth-switch">
                        Already have an account?
                        <button class="btn-link-inline" id="showLogin">Sign In</button>
                    </p>
                </div>

                <!-- Continue without account -->
                <div class="auth-skip">
                    <hr>
                    <button class="btn btn-tertiary" id="skipAuthBtn">Continue without account</button>
                    <p class="auth-skip-note">Your data will only be saved locally on this device</p>
                </div>
            </div>
        </div>

        <!-- Screen 1: Mood Selection (Flares) -->
        <div class="screen" id="moodScreen">
            <div class="screen-content">
                <h1 class="screen-title">How are you feeling?</h1>
                <p class="screen-subtitle">Select your current state</p>

                <div class="flares-container">
                    <button class="flare-btn green" data-mood="green">
                        <div class="flare-light"></div>
                        <span class="flare-label">Stable</span>
                        <span class="flare-desc">Feeling good and in control</span>
                    </button>

                    <button class="flare-btn orange" data-mood="orange">
                        <div class="flare-light"></div>
                        <span class="flare-label">Struggling</span>
                        <span class="flare-desc">Finding things challenging</span>
                    </button>

                    <button class="flare-btn red" data-mood="red">
                        <div class="flare-light"></div>
                        <span class="flare-label">Overwhelmed</span>
                        <span class="flare-desc">Need support right now</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Screen 2: Emoji Selection -->
        <div class="screen" id="emojiScreen">
            <div class="screen-content">
                <h1 class="screen-title">What describes your mood?</h1>
                <p class="screen-subtitle">Select one or more emotions</p>

                <div class="emoji-grid" id="emojiGrid">
                    <!-- Populated dynamically based on mood -->
                </div>

                <div class="screen-actions">
                    <button class="btn btn-secondary" id="backToMood">Back</button>
                    <button class="btn btn-primary" id="continueToTriggers">Continue</button>
                </div>
            </div>
        </div>

        <!-- Screen 3: Triggers Selection -->
        <div class="screen" id="triggersScreen">
            <div class="screen-content">
                <h1 class="screen-title">What might have contributed?</h1>
                <p class="screen-subtitle">Select any relevant triggers (optional)</p>

                <div class="triggers-grid" id="triggersGrid">
                    <!-- Populated dynamically based on mood -->
                </div>

                <div class="screen-actions">
                    <button class="btn btn-secondary" id="backToEmoji">Back</button>
                    <button class="btn btn-primary" id="continueToPreview">Continue</button>
                </div>
            </div>
        </div>

        <!-- Screen 4: Notification Preview & Send -->
        <div class="screen" id="previewScreen">
            <div class="screen-content">
                <h1 class="screen-title">Ready to share</h1>
                <p class="screen-subtitle">Review and send to your support network</p>

                <div class="notification-preview" id="notificationPreview">
                    <!-- Preview populated dynamically -->
                </div>

                <div class="support-list" id="supportList">
                    <h3>Send to:</h3>
                    <div class="supports-container" id="supportsContainer">
                        <!-- Support contacts populated dynamically -->
                    </div>
                    <button class="btn btn-link" id="manageSupportBtn">Manage Support Contacts</button>
                </div>

                <div class="screen-actions">
                    <button class="btn btn-secondary" id="backToTriggers">Back</button>
                    <button class="btn btn-primary" id="sendNotification">Send via Email</button>
                    <button class="btn btn-primary" id="sendViaSMS" style="display: none;">Send via SMS</button>
                    <button class="btn btn-tertiary" id="shareViaLink">Share via Link</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button class="modal-close" id="closeSettings">√ó</button>
                </div>
                <div class="modal-body">
                    <!-- User Profile Section -->
                    <div class="user-profile-section" id="userProfileSection" style="display: none;">
                        <div class="user-profile-card">
                            <div class="user-avatar" id="userAvatar">U</div>
                            <div class="user-info">
                                <div class="user-name" id="userName">User</div>
                                <div class="user-email" id="userEmail">user@example.com</div>
                            </div>
                            <div class="sync-status" id="syncStatus">
                                <span class="sync-icon">‚òÅÔ∏è</span>
                                <span class="sync-text">Synced</span>
                            </div>
                        </div>
                        <button class="btn btn-secondary btn-logout" id="logoutBtn">Sign Out</button>
                    </div>

                    <div class="guest-mode-notice" id="guestModeNotice" style="display: none;">
                        <p class="guest-notice-text">You're using Flares without an account. Your data is only saved on this device.</p>
                        <button class="btn btn-primary btn-small" id="createAccountBtn">Create Account to Sync</button>
                    </div>

                    <hr>

                    <h3>Support Contacts</h3>
                    <p class="help-text">Add people who can receive your Flares notifications</p>

                    <div class="contacts-list" id="contactsList">
                        <!-- Contacts populated dynamically -->
                    </div>

                    <div class="add-contact-form">
                        <input type="text" id="contactName" placeholder="Name" class="input">
                        <input type="email" id="contactEmail" placeholder="Email" class="input">
                        <button class="btn btn-primary" id="addContactBtn">Add Contact</button>
                    </div>

                    <hr>

                    <!-- Linked Contacts Section (Push Notifications) -->
                    <div class="linked-contacts-section" id="linkedContactsSection" style="display: none;">
                        <h3>Linked Contacts</h3>
                        <p class="help-text">Connect with people who have Flares to send instant push notifications</p>

                        <div class="link-actions">
                            <button class="btn btn-primary" id="generateLinkCodeBtn">Generate My Code</button>
                            <button class="btn btn-secondary" id="enterLinkCodeBtn">Enter a Code</button>
                        </div>

                        <div class="linked-contacts-list" id="linkedContactsList">
                            <!-- Linked contacts populated dynamically -->
                        </div>

                        <hr>
                    </div>

                    <h3>Customization</h3>
                    <div class="customization-buttons">
                        <button class="btn btn-secondary" id="manageCustomEmojisBtn">Manage Custom Emojis</button>
                        <button class="btn btn-secondary" id="manageCustomTriggersBtn">Manage Custom Triggers</button>
                    </div>

                    <hr>

                    <h3>Your History</h3>
                    <div class="history-list" id="historyList">
                        <!-- History populated dynamically -->
                    </div>
                    <button class="btn btn-link" id="clearHistoryBtn">Clear History</button>
                </div>
            </div>
        </div>

        <!-- Custom Emojis Modal -->
        <div class="modal" id="customEmojisModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Custom Emojis</h2>
                    <button class="modal-close" id="closeCustomEmojis">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="help-text">Create custom emoji feelings that match your experiences</p>

                    <div class="custom-emojis-list" id="customEmojisList">
                        <!-- Custom emojis populated dynamically -->
                    </div>

                    <button class="btn btn-primary" id="addCustomEmojiBtn">+ Add Custom Emoji</button>
                </div>
            </div>
        </div>

        <!-- Add Custom Emoji Modal -->
        <div class="modal" id="addEmojiModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Custom Emoji</h2>
                    <button class="modal-close" id="closeAddEmoji">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-section">
                        <label>Emoji</label>
                        <button class="emoji-picker-btn" id="emojiPickerBtn">
                            <span id="selectedEmojiDisplay">Tap to select emoji</span>
                        </button>
                    </div>

                    <div class="form-section">
                        <label>Feeling/Emotion Label</label>
                        <input type="text" id="emojiLabelInput" placeholder="e.g., Anxious, Happy, Tired" class="input">
                    </div>

                    <div class="form-section">
                        <label>Associated Mood Colors</label>
                        <p class="help-text small">Select which traffic light colors this feeling applies to</p>
                        <div class="color-checkboxes">
                            <label class="color-checkbox green">
                                <input type="checkbox" value="green" class="emoji-color-cb">
                                <span class="color-indicator"></span>
                                <span>Stable</span>
                            </label>
                            <label class="color-checkbox orange">
                                <input type="checkbox" value="orange" class="emoji-color-cb">
                                <span class="color-indicator"></span>
                                <span>Struggling</span>
                            </label>
                            <label class="color-checkbox red">
                                <input type="checkbox" value="red" class="emoji-color-cb">
                                <span class="color-indicator"></span>
                                <span>Overwhelmed</span>
                            </label>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelAddEmoji">Cancel</button>
                        <button class="btn btn-primary" id="saveCustomEmoji">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emoji Picker Modal -->
        <div class="modal" id="emojiPickerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Select Emoji</h2>
                    <button class="modal-close" id="closeEmojiPicker">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="emoji-picker-grid" id="emojiPickerGrid">
                        <!-- Emoji picker populated dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Custom Triggers Modal -->
        <div class="modal" id="customTriggersModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Custom Triggers</h2>
                    <button class="modal-close" id="closeCustomTriggers">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="help-text">Create custom triggers specific to your experiences</p>

                    <div class="custom-triggers-list" id="customTriggersList">
                        <!-- Custom triggers populated dynamically -->
                    </div>

                    <button class="btn btn-primary" id="addCustomTriggerBtn">+ Add Custom Trigger</button>
                </div>
            </div>
        </div>

        <!-- Add Custom Trigger Modal -->
        <div class="modal" id="addTriggerModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Custom Trigger</h2>
                    <button class="modal-close" id="closeAddTrigger">√ó</button>
                </div>
                <div class="modal-body">
                    <div class="form-section">
                        <label>Trigger/Reason</label>
                        <input type="text" id="triggerLabelInput" placeholder="e.g., Bright fluorescent lights" class="input">
                    </div>

                    <div class="form-section">
                        <label>Category</label>
                        <p class="help-text small">Choose which category this trigger belongs to</p>
                        <div class="category-radios">
                            <label class="category-radio">
                                <input type="radio" name="triggerCategory" value="sensory">
                                <span class="category-icon">üëÇ</span>
                                <span>Sensory</span>
                            </label>
                            <label class="category-radio">
                                <input type="radio" name="triggerCategory" value="physical">
                                <span class="category-icon">üèÉ</span>
                                <span>Physical</span>
                            </label>
                            <label class="category-radio">
                                <input type="radio" name="triggerCategory" value="emotional">
                                <span class="category-icon">‚ù§Ô∏è</span>
                                <span>Emotional</span>
                            </label>
                            <label class="category-radio">
                                <input type="radio" name="triggerCategory" value="cognitive">
                                <span class="category-icon">üß†</span>
                                <span>Cognitive</span>
                            </label>
                        </div>
                    </div>

                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelAddTrigger">Cancel</button>
                        <button class="btn btn-primary" id="saveCustomTrigger">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Modal -->
        <div class="modal" id="successModal">
            <div class="modal-content success">
                <div class="success-icon">‚úì</div>
                <h2>Notification Sent!</h2>
                <p>Your support network has been notified.</p>
                <button class="btn btn-primary" id="doneBtn">Done</button>
            </div>
        </div>

        <!-- Share Link Modal -->
        <div class="modal" id="shareLinkModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Share via Link</h2>
                    <button class="modal-close" id="closeShareLink">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="help-text">Copy this link to share your current state:</p>
                    <div class="share-link-container">
                        <input type="text" id="shareLink" readonly class="input share-link">
                        <button class="btn btn-primary" id="copyLinkBtn">Copy</button>
                    </div>
                    <p class="help-text small">You can send this link via text, messenger, or any app you prefer.</p>
                </div>
            </div>
        </div>

        <!-- Generate Link Code Modal -->
        <div class="modal" id="generateCodeModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Your Link Code</h2>
                    <button class="modal-close" id="closeGenerateCode">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="help-text">Share this code with someone you want to connect with. They can enter it in their Flares app.</p>
                    <div class="link-code-display" id="linkCodeDisplay">
                        <span class="link-code">------</span>
                    </div>
                    <p class="link-code-expiry" id="linkCodeExpiry">Expires in 10 minutes</p>
                    <button class="btn btn-primary" id="copyCodeBtn">Copy Code</button>
                    <p class="help-text small">Once they enter this code, you'll be able to send each other Flare notifications instantly.</p>
                </div>
            </div>
        </div>

        <!-- Enter Link Code Modal -->
        <div class="modal" id="enterCodeModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Enter Link Code</h2>
                    <button class="modal-close" id="closeEnterCode">√ó</button>
                </div>
                <div class="modal-body">
                    <p class="help-text">Enter the 6-digit code from someone you want to connect with.</p>
                    <div class="form-section">
                        <input type="text" id="linkCodeInput" placeholder="Enter 6-digit code" class="input link-code-input" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                    </div>
                    <div class="link-code-error" id="linkCodeError"></div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelEnterCode">Cancel</button>
                        <button class="btn btn-primary" id="submitLinkCode">Link</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="flares.js"></script>
</body>
</html>
